import { computed } from "vue";
import { useSettingsStore } from "../stores/settings";
import type { Locale } from "./locale";

type MessageBundle = Record<string, string>;

export const messages: Record<Locale, MessageBundle> = {
  en: {
    "app.title": "Modbus TCP Server",
    "app.connections": "Connections",
    "connection.host": "Host",
    "connection.port": "Port",
    "connection.unitId": "Unit ID",
    "connection.bind": "Bind",
    "connection.status": "Status",
    "connection.start": "Start",
    "connection.stop": "Stop",
    "status.running": "Running",
    "status.stopped": "Stopped",
    "status.unbound": "Not bound",
    "navigation.title": "Navigation",
    "navigation.startAddress": "Start Address",
    "navigation.displayLength": "Display Length",
    "navigation.prev": "Prev",
    "navigation.next": "Next",
    "navigation.apply": "Apply",
    "navigation.refresh": "Refresh",
    "navigation.tips": "Tips",
    "navigation.portTip": "Port 502 requires admin privileges, use 1502 for testing.",
    "settings.title": "Settings",
    "settings.language": "Language",
    "settings.language.en": "English",
    "settings.language.zh-CN": "中文",
    "settings.modal.close": "Close",
    "dataAreas.title": "Data Areas",
    "dataAreas.coils": "Coils",
    "dataAreas.coilsHint": "Writable",
    "dataAreas.discrete": "Discrete",
    "dataAreas.discreteHint": "Discrete inputs",
    "dataAreas.input": "Input Reg",
    "dataAreas.inputHint": "Input registers",
    "dataAreas.holding": "Holding Reg",
    "dataAreas.holdingHint": "Holding registers",
    "registers.title": "Registers",
    "registers.modbusAddress": "Modbus Address",
    "registers.value": "Value",
    "registers.on": "On",
    "registers.off": "Off",
    "statusBar.bind": "Bind",
    "statusBar.connections": "Connections",
    "console.scriptEditor": "Script Editor",
    "console.logs": "Logs",
    "console.running": "Running",
    "console.expand": "Expand",
    "console.collapse": "Collapse",
    "console.fileUnsaved": "Unsaved example (use Save As)",
    "console.fileChanged": "File changed on disk",
    "console.reload": "Reload",
    "console.keep": "Keep",
    "console.open": "Open",
    "console.save": "Save",
    "console.saveAs": "Save As",
    "console.example": "Example",
    "console.stop": "Stop",
    "console.run": "Run",
    "console.noLogs": "No logs yet.",
    "console.followLogs": "Follow logs",
    "console.saveLogs": "Save logs",
    "console.clear": "Clear",
    "console.logsHint":
      "Logs will show script runs, register writes, and connection events.",
    "console.log.noLogsToSave": "No logs to save.",
    "console.log.savedLogs": "Saved logs to {path}",
    "console.log.failedSaveLogs": "Failed to save logs.",
    "console.log.callbackError": "{context} error: {error}",
    "console.log.registerListenerFailed": "Failed to register onChange listener.",
    "console.log.stopRequested": "Stop requested.",
    "console.log.alreadyRunning": "Script is already running.",
    "console.log.started": "Script started.",
    "console.log.finished": "Script finished.",
    "console.log.stopped": "Script stopped.",
    "console.log.error": "Script error: {error}",
    "console.log.idle": "Script idle. Waiting for stop.",
    "console.log.watchFailed": "Watch failed.",
    "console.log.externalChange": "Detected external change.",
    "console.log.failedReadChanges": "Failed to read file changes.",
    "console.log.reloaded": "Reloaded from disk.",
    "console.log.keptLocal": "Kept local changes.",
    "console.log.opened": "Opened {path}",
    "console.log.failedOpen": "Failed to open file.",
    "console.log.saved": "Saved {path}",
    "console.log.failedSave": "Failed to save file.",
    "console.log.loadedExample": "Loaded example template.",
    "console.confirm.discard": "Discard unsaved changes?",
    "console.confirm.unsavedTitle": "Unsaved changes",
  },
  "zh-CN": {
    "app.title": "Modbus TCP 服务器",
    "app.connections": "连接数",
    "connection.host": "监听地址",
    "connection.port": "端口",
    "connection.unitId": "站号",
    "connection.bind": "绑定",
    "connection.status": "状态",
    "connection.start": "启动",
    "connection.stop": "停止",
    "status.running": "运行中",
    "status.stopped": "已停止",
    "status.unbound": "未绑定",
    "navigation.title": "导航",
    "navigation.startAddress": "起始地址",
    "navigation.displayLength": "显示长度",
    "navigation.prev": "上一页",
    "navigation.next": "下一页",
    "navigation.apply": "跳转",
    "navigation.refresh": "刷新",
    "navigation.tips": "提示",
    "navigation.portTip": "端口 502 需要管理员权限，建议使用 1502 进行测试。",
    "settings.title": "设置",
    "settings.language": "语言",
    "settings.language.en": "English",
    "settings.language.zh-CN": "中文",
    "settings.modal.close": "关闭",
    "dataAreas.title": "数据区",
    "dataAreas.coils": "线圈",
    "dataAreas.coilsHint": "可写",
    "dataAreas.discrete": "离散输入",
    "dataAreas.discreteHint": "离散输入",
    "dataAreas.input": "输入寄存器",
    "dataAreas.inputHint": "输入寄存器",
    "dataAreas.holding": "保持寄存器",
    "dataAreas.holdingHint": "保持寄存器",
    "registers.title": "寄存器",
    "registers.modbusAddress": "Modbus 地址",
    "registers.value": "数值",
    "registers.on": "开",
    "registers.off": "关",
    "statusBar.bind": "绑定",
    "statusBar.connections": "连接数",
    "console.scriptEditor": "脚本编辑器",
    "console.logs": "运行日志",
    "console.running": "运行中",
    "console.expand": "展开",
    "console.collapse": "收起",
    "console.fileUnsaved": "未保存的示例（使用“另存为”）",
    "console.fileChanged": "文件已更新",
    "console.reload": "重新载入",
    "console.keep": "保留",
    "console.open": "打开",
    "console.save": "保存",
    "console.saveAs": "另存为",
    "console.example": "示例",
    "console.stop": "停止",
    "console.run": "运行",
    "console.noLogs": "暂无日志。",
    "console.followLogs": "跟踪日志",
    "console.saveLogs": "保存日志",
    "console.clear": "清空",
    "console.logsHint": "日志会展示脚本运行、寄存器写入和连接事件。",
    "console.log.noLogsToSave": "没有可保存的日志。",
    "console.log.savedLogs": "日志已保存到 {path}",
    "console.log.failedSaveLogs": "保存日志失败。",
    "console.log.callbackError": "{context} 错误：{error}",
    "console.log.registerListenerFailed": "注册 onChange 监听失败。",
    "console.log.stopRequested": "已请求停止。",
    "console.log.alreadyRunning": "脚本已在运行。",
    "console.log.started": "脚本已启动。",
    "console.log.finished": "脚本已完成。",
    "console.log.stopped": "脚本已停止。",
    "console.log.error": "脚本错误：{error}",
    "console.log.idle": "脚本空闲，等待停止。",
    "console.log.watchFailed": "文件监听失败。",
    "console.log.externalChange": "检测到外部更改。",
    "console.log.failedReadChanges": "读取文件变更失败。",
    "console.log.reloaded": "已从磁盘重新载入。",
    "console.log.keptLocal": "保留本地修改。",
    "console.log.opened": "已打开 {path}",
    "console.log.failedOpen": "打开文件失败。",
    "console.log.saved": "已保存 {path}",
    "console.log.failedSave": "保存文件失败。",
    "console.log.loadedExample": "已加载示例模板。",
    "console.confirm.discard": "放弃未保存的修改？",
    "console.confirm.unsavedTitle": "未保存的修改",
  },
};

function interpolate(template: string, params: Record<string, string | number>): string {
  return template.replace(/\{(\w+)\}/g, (_, key: string) => {
    const value = params[key];
    return value === undefined ? `{${key}}` : String(value);
  });
}

export function useI18n() {
  const settings = useSettingsStore();
  const locale = computed(() => settings.locale);

  const t = (key: string, params?: Record<string, string | number>) => {
    const message =
      messages[settings.locale]?.[key] ?? messages.en[key] ?? key;
    if (!params) {
      return message;
    }
    return interpolate(message, params);
  };

  return { t, locale };
}
